---
layout: post
title: "Rails Friends: API and Webpacker"
date: 2020-03-01 12:00:00 -0400
image: /assets/images/posts/erfan-moradi-r8cwrYe40rU-unsplash.jpg
tags:
  - rails
  - webpack
---

It appears you can not use `--api` and `--webpack=react` together when creating a new Rails App. It's a shame, because having Rails handle the backend and React, or other JS framework, handle the frontend is a common setup. But it is possible to add webpacker to an api App and use HtmlWebpackPlugin to serve the webpack bundles.

Nothing on the `rails new` documentation suggest that the two are incompatible, but running `rails new rails-api-webpacker-demo --api --webpack=react` together, [appears to ignore](https://github.com/leonelgalan/rails-api-webpacker-demo/compare/both-flags...only-webpack) the webpacker configuration steps.

```sh
$ rails new --help
...
    [--api], [--no-api]          # Preconfigure smaller stack for API only apps
--webpacker, [--webpack=WEBPACK] # Preconfigure Webpack with a particular framework (options: react, ...)
...
```

I found this [comment](https://github.com/rails/webpacker/issues/1361#issuecomment-374682079) on a Webpacker issue titled: "Rails API + Webpacker?". This blog post is based on the [linked repository](https://github.com/gauravtiwari/webpacker-api-frontend), broken down into steps for easier understanding.

## Tutorial

### Create an `--api` App

Because `--api` preconfigures a smaller stack, let's start with it and add webpacker later.

```sh
rails new rails-api-webpacker-demo --api
```

### Install Webpacker

Add to _Gemfile_:

```ruby
gem 'webpacker'
```

Run:

```sh
bundle install
rails webpacker:install
rails webpacker:install:react
```

### Install HtmlWebpackPlugin and HtmlWebpackHarddiskPlugin

Run:

```sh
yarn add html-webpack-plugin html-webpack-harddisk-plugin
```

Configure the installed plugins in _config/webpack/environment.js_ according to their documentation [(1)](https://github.com/jantimon/html-webpack-plugin#options)[(2)](https://github.com/jantimon/html-webpack-harddisk-plugin#basic-usage):

```js
const { environment } = require('@rails/webpacker')

const HtmlWebpackPlugin = require('html-webpack-plugin')
const HtmlWebpackHarddiskPlugin = require('html-webpack-harddisk-plugin')

environment.plugins.append(
  'html',
  new HtmlWebpackPlugin({
    alwaysWriteToDisk: true
  })
)

environment.plugins.append(
  'html-harddisk',
  new HtmlWebpackHarddiskPlugin()
)

module.exports = environment
```

[`a8fad1d`](https://github.com/leonelgalan/rails-api-webpacker-demo/commit/a8fad1d0b8ae0a356910de492d412493a7305f7f)

### Setup Rails to Serve the HTML Generated by Webpack

```sh
rails generate controller pages index
```

Rewrite the pages controller to:

1. Inherit from `ActionController::Base`. Because this is an API app, `ApplicationController` inherits from `ActionController::API` instead
2. Have `:index` render the file generated by webpack

```ruby
class PagesController < ActionController::Base
  def index
    render file: 'public/packs/index.html'
  end
end

```

Remove  the `get 'pages/index'` added to routes (_config/routes.rb_) and add:

```ruby
root 'pages#index', as: :pages_index
get '*path', to: 'pages#index'
```

[`6ff32b0`](https://github.com/leonelgalan/rails-api-webpacker-demo/commit/6ff32b0388e3044a51b443b68750fec4fddfae57)

### Conclusion

Run both commands in different terminals:

```sh
webpack-dev-server
```

```sh
rails server
```

Open _http://localhost:3000/_ and you'll see both: "Hello React" in the body and "Hello World from Webpacker" in the browserâ€™s console.

I've published this on Github at [leonelgalan/rails-api-webpacker-demo](https://github.com/leonelgalan/rails-api-webpacker-demo) and deployed to Heroku as [ancient-falls-96742.herokuapp.com](https://ancient-falls-96742.herokuapp.com/)

___

<small>
  Photo by [Erfan Moradi](https://unsplash.com/photos/r8cwrYe40rU)
</small>
